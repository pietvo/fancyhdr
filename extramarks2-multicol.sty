%%
%% This is file `extramarks2-multicol.sty',
%%
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks2-multicol}
           [2021/03/07 v0.1
                  Extra marks for LaTeX]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
    % Here comes the multicol patching code.
    %
    % For now:
    % (1)  patch \return@nonemptymark         => insert marks in stream
    % (2)  patch \prep@keptmarks              => INIT code
    % (3)  patch \set@keptmarks               => For each box code
    % (4)  Patch where \@outputpage is called => END code

% (1)
\cs_new_protected:Npn \extramarks@return@nonemptymarks #1
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \tl_if_empty:cF {g__extramarks_#1mark_##1_tl}
        {
          \tex_marks:D \use:c{c__extramarks_##1_int} {\use:c{g__extramarks_#1mark_##1_tl}}
          \message{\string\xmarks \use:c{c__extramarks_##1_int} {\use:c{g__extramarks_#1mark_##1_tl}}}
        }
    }
}

% (2)
\cs_new_protected:Npn \extramarks@prep@keptmarks
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % INIT:
      \__extramarks_get_boxmarks_init:n { ##1 }
      \message{\string\__extramarks_get_boxmarks_init:n { ##1 }}
    }
}

% (3)
\cs_new_protected:Npn \extramarks@set@keptmarks
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % Process any marks in the box
      \__extramarks_get_boxmarks:n { ##1 }
      \message{\string\__extramarks_get_boxmarks:n { ##1 }}
    }
}

% (4)
%
\cs_new_protected:Npn \extramarks@multi@column@out
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % END code:
      \__extramarks_get_boxmarks_end:n { ##1 }
      \message{\string\__extramarks_get_boxmarks_end:n { ##1 }}
    }
}


\ExplSyntaxOff

% The functions to be patched are in LaTeX2e syntax, so we can't use
% expl3 here. So no _ and : in their names.

% (1)
\pretocmd{\return@nonemptymark}
  {
    \extramarks@return@nonemptymarks {#1}
  }
  {\message{Patch \string\return@nonemptymark\space  OK}}
  {\message{Patch \string\return@nonemptymark\space  failed}}
  %\show\return@nonemptymark

% (2)
\pretocmd{\prep@keptmarks}
  {
    \extramarks@prep@keptmarks
  }
  {\message{Patch \string\prep@keptmarks\space  OK}}
  {\message{Patch \string\prep@keptmarks\space  failed}}
  %\show\rprep@keptmarks

\tracingpatches
% (3)
\pretocmd{\set@keptmarks}
  {
    \extramarks@set@keptmarks
  }
  {\message{Patch \string\set@keptmarks\space  OK}}
  {\message{Patch \string\set@keptmarks\space  failed}}
  %\show\rprep@keptmarks

% (4)
\patchcmd{\multi@column@out} {\@outputpage}
  {
    \extramarks@multi@column@out
    \@outputpage
  }


% \endinput
%%
%% End of file `extramarks2-multicol.sty'.
