%% -*- mode: latex -*-
%% This is file `extramarks2-multicol.tex',
%%
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesFile{extramarks2-multicol.tex}
           [2021/03/13 v0.1
                  Extra marks for LaTeX (multicol extension)]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn

% Debugging

\cs_new:Nn \extramarks_show_mark:n
{
  \token_to_str:c { #1 } -> \use:c { #1 }\MessageBreak
}

% Here comes the multicol patching code.
%
% For now:
% (1)  patch \return@nonemptymark         => insert marks in stream
% (2)  patch \prep@keptmarks              => INIT code (only clear marks)
% (3)  patch \set@keptmarks               => For each box code
% (4)  Patch where \@outputpage is called => END code before, INIT code after

% (1)
\cs_new_protected:Npn \extramarks@return@nonemptymarks #1
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \tl_if_empty:cF {g__extramarks_#1mark_##1_tl}
        {
          \tex_marks:D \use:c{c__extramarks_##1_int} {\use:c{g__extramarks_#1mark_##1_tl}}
          \mult@info\tw@
          {
            In~\string\return@nonemptymarks~{#1}\MessageBreak
            \string\xmarks \use:c{c__extramarks_##1_int}
              {\use:c{g__extramarks_#1mark_##1_tl}}\MessageBreak
          }
        }
    }
}

% (2)
\cs_new_protected:Npn \extramarks@prep@keptmarks
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % INIT:
      \tl_gset_eq:cN { g__extramarks_firstmark_##1_tl } \c_empty_tl
      \tl_gset_eq:cN { g__extramarks_botmark_##1_tl } \c_empty_tl
      \mult@info\tw@
        {
          Clear marks { ##1 }~in~\string\prep@keptmarks\MessageBreak
          \extramarks_show_mark:n  { g__extramarks_topmark_##1_tl }
          \extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
       }
    }
}

% (3)
\cs_new_protected:Npn \extramarks@set@keptmarks
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % Process any marks in the box
      \__extramarks_get_boxmarks:n { ##1 }
      \mult@info\tw@
        {
          \string\__extramarks_get_boxmarks:n { ##1 }~in~\string\set@keptmarks\MessageBreak
          \extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
          \extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
       }
    }
}

% (4)
\cs_new_protected:Npn \extramarks@multi@column@outputpage
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % END code:
      \__extramarks_get_boxmarks_end:n { ##1 }
      \mult@info\tw@
        {
          \string\__extramarks_get_boxmarks_end:n { ##1 }~in~\string\multi@column@out\MessageBreak
          \extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
          \extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
       }
    }
  \@makecol\@outputpage
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      % INIT code
      \__extramarks_get_boxmarks_init:n { ##1 }
      \mult@info\tw@
        {
          \string\__extramarks_get_boxmarks_init:n
            { ##1 }~in~\string\multi@column@out\MessageBreak
          \extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
          \extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
       }
     }
}

\ExplSyntaxOff

% The functions to be patched are in LaTeX2e syntax, so we can't use
% expl3 here. Therefore no _ and : in their names.

% (1)
\pretocmd{\return@nonemptymark}
  {
    \if@boxedmulticols\else\extramarks@return@nonemptymarks {#1}\fi
  }
  {}
  {\msg@error@nnn {extramarks2} {cannot-patch} {\return@nonemptymark}}
  %\show\return@nonemptymark

% (2)
\pretocmd{\prep@keptmarks}
  {
    \extramarks@prep@keptmarks
  }
  {}
  {\msg@error@nnn {extramarks2} {cannot-patch} {\prep@keptmarks}}
  %\show\prep@keptmarks

% (3)
\pretocmd{\set@keptmarks}
  {
    \if@boxedmulticols\else\extramarks@set@keptmarks\fi
  }
  {}
  {\msg@error@nnn {extramarks2} {cannot-patch} {\set@keptmarks}}
  %\show\set@keptmarks

% (4)
\patchcmd{\multi@column@out} {\@makecol\@outputpage}
  {
    \extramarks@multi@column@outputpage
  }
  {}
  {\msg@error@nnn {extramarks2} {cannot-patch} {\multi@column@out}}
  %\show\multi@column@out

\endinput
%%
%% End of file `extramarks2-multicol.tex'.
