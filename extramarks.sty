%%
%% This is file `extramarks.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% fancyhdr.dtx  (with options: `extramarks')
%% 
%% This is a generated file.
%% 
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%% 
%%    http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks}
           [2022/03/17 v5.0beta
                  Extra marks for LaTeX]
% Copyright (C) 1994-2022 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\providecommand\DeclareRelease[3]{}
\providecommand\DeclareCurrentRelease[2]{}
\DeclareRelease{v3}{2021-01-01}{extramarks-v3.sty}
\DeclareCurrentRelease{}{2021-03-22}

\RequirePackage{expl3,xparse}
\RequirePackage{etoolbox}
\ExplSyntaxOn
\seq_new:N \g__extramarks_marks_seq
\box_new:N \l__extramarks_temp_box
\tl_new:N \l__extramarks_temp_tl
\cs_new:Nn \__extramarks_show_mark:n
{
  \token_to_str:c { #1 } -> \tl_to_str:c { #1 }\MessageBreak
}
\cs_new_eq:NN \extramarks@info \use_none:n
\DeclareOption{debugshow}{%
\cs_gset_protected:Npn \extramarks@info #1
  {
   \GenericWarning
       {(extramarks)\@spaces\@spaces}
       {Package~extramarks:~#1}
  }
}
\ProcessOptions*
\msg_new:nnn {extramarks} {not-defined} {\token_to_str:N #1:~mark~#2~not~defined}
\msg_new:nnn {extramarks} {already-defined} {\token_to_str:N #1:~mark~#2~already~defined}
\msg_new:nnn {extramarks} {cannot-patch} {Patch ~ \token_to_str:N #1~failed}
\cs_new_eq:NN \msg@error@nnn  \msg_error:nnn
\cs_new_eq:NN \msg@error@nnnn \msg_error:nnnn
\NewDocumentCommand \extramarksnewmark { m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
    { \msg_error:nnnn {extramarks} {already-defined}
      {\extramarksnewmark} {#1} }
    {
      \exp_args:Nc \newmarks {c__extramarks_#1_int}
      \seq_put_right:Nn \g__extramarks_marks_seq { #1 }
      \tl_new:c {g__extramarks_topmark_#1_tl}
      \tl_new:c {g__extramarks_firstmark_#1_tl}
      \tl_new:c {g__extramarks_botmark_#1_tl}
      \tl_gset:cn {g__extramarks_topmark_#1_tl} {{}}
    }
}
\cs_new_protected:Npn \__extramarks_get_boxmarks_init:n #1
{
  \tl_if_empty:cF { g__extramarks_botmark_#1_tl }
    {
      \tl_gset_eq:cc { g__extramarks_topmark_#1_tl } { g__extramarks_botmark_#1_tl }
    }
  \tl_gset_eq:cN { g__extramarks_firstmark_#1_tl } \c_empty_tl
  \tl_gset_eq:cN { g__extramarks_botmark_#1_tl } \c_empty_tl
}
\cs_new_protected:Npn \__extramarks_get_boxmarks:n #1
{
  \tl_gset:No \l__extramarks_temp_tl
    { \splitfirstmarks \use:c { c__extramarks_#1_int } }
  \tl_if_empty:NF \l__extramarks_temp_tl
    {
      \tl_if_empty:cT { g__extramarks_firstmark_#1_tl }
        {
          \tl_gset_eq:cN { g__extramarks_firstmark_#1_tl } \l__extramarks_temp_tl
        }
      \tl_gset:co { g__extramarks_botmark_#1_tl }
        { \splitbotmarks \use:c { c__extramarks_#1_int } }
    }
}
\cs_new_protected:Npn \__extramarks_boxmarks:n #1
{
  \tl_gset:No \l__extramarks_temp_tl
    { \splitfirstmarks \use:c{c__extramarks_#1_int} }
  \tl_if_empty:NF \l__extramarks_temp_tl
    {
      \tl_gset_eq:cN { g__extramarks_firstmark_#1_tl } \l__extramarks_temp_tl
      \tl_gset:co { g__extramarks_botmark_#1_tl }
        { \splitbotmarks \use:c{c__extramarks_#1_int} }
    }
}
\int_new:N \l__extramarks_errorcontextlines
\cs_new_protected:Npn \__extramarks_vsplit_box #1
{
    \dim_set:Nn \tex_splitmaxdepth:D \c_max_dim
    \int_set:Nn \tex_vbadness:D      \c_max_int
    \vbox_set:Nn \l__extramarks_temp_box { \unvcopy #1 \unskip }
    \int_set_eq:NN \l__extramarks_errorcontextlines \errorcontextlines
    \int_set:Nn \errorcontextlines {-1}
    \vbox_set_split_to_ht:NNn \l__extramarks_temp_box \l__extramarks_temp_box \c_max_dim
    \int_set_eq:NN \errorcontextlines \l__extramarks_errorcontextlines
}
\cs_new_eq:NN \extramarks@saved@outputpage \@outputpage
\cs_new_protected:Npn \extramarks@get@splitmarks #1
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \__extramarks_get_boxmarks:n { ##1 }
      \extramarks@info
        {
          \string \__extramarks_get_boxmarks:n \space { ##1 }~in~\string #1\MessageBreak
          \__extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
          \__extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
        }
    }
}
\cs_new_protected:Npn \extramarks@insert@nonemptymarks #1 #2
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \tl_if_empty:cF {g__extramarks_#1mark_##1_tl}
        {
          \tex_marks:D \use:c{c__extramarks_##1_int} {\exp_not:v {g__extramarks_#1mark_##1_tl}}
          \extramarks@info
            {
              In~\string \insert@nonemptymarks \space {#1}~from~\string #2\MessageBreak
              \string \xmarks \use:c{c__extramarks_##1_int}
                {\tl_to_str:c {g__extramarks_#1mark_##1_tl}}\MessageBreak
            }
        }
    }
}
\cs_new_protected:Npn \extramarks@set@marks@topnewpage #1
{
  \group_begin:
    \global\setbox\@currbox\vbox{
        \hsize\textwidth
        \@parboxrestore
        \col@number \@ne
        #1
        \vskip -\dbltextfloatsep
             }
    \__extramarks_vsplit_box \@currbox
    \extramarks@get@splitmarks{\@topnewpage}
    \global \setbox\@currbox
    \color@vbox
      \normalcolor
      \copy\@currbox
    \color@endbox
  \group_end:
}
\cs_new_protected:Npn \extramarks@getmarks #1 #2
{
  \extramarks@info
  {
    \string \extramarks@getmarks \space (\string #1)~in~\string #2\MessageBreak
  }
  \group_begin:
    \__extramarks_vsplit_box #1
    \extramarks@get@splitmarks { #2 }
  \group_end:
}
\cs_new_protected:Npn \extramarks@getlocalmarks #1 #2
{
  \group_begin:
    \__extramarks_vsplit_box #1
    \seq_map_inline:Nn \g__extramarks_marks_seq
      {
        \__extramarks_boxmarks:n { ##1 }
        \extramarks@info
          {
            \string \__extramarks_boxmarks:n \space { ##1 }~in~\string #2\MessageBreak
            \__extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
            \__extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
          }
      }
  \group_end:
}
\cs_new_protected:Npn \extramarks@initmarks
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
  {
    \__extramarks_get_boxmarks_init:n { ##1 }
    \extramarks@info
      {
        \string \__extramarks_get_boxmarks_init:n \space { ##1 }\MessageBreak
        \__extramarks_show_mark:n  { g__extramarks_topmark_##1_tl }
        \__extramarks_show_mark:n  { g__extramarks_firstmark_##1_tl }
        \__extramarks_show_mark:n  { g__extramarks_botmark_##1_tl }
      }
  }
}
\cs_new_protected:Npn \extramarks@savemarks #1
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \tl_set_eq:cc {l__extramarks_save_topmark_##1_tl} {g__extramarks_topmark_##1_tl}
      \tl_set_eq:cc {l__extramarks_save_firstmark_##1_tl} {g__extramarks_firstmark_##1_tl}
      \tl_set_eq:cc {l__extramarks_save_botmark_##1_tl} {g__extramarks_botmark_##1_tl}
      \extramarks@info
        {
          \string \extramarks@savemarks \space in~\string #1\MessageBreak
          \__extramarks_show_mark:n { g__extramarks_topmark_##1_tl }
          \__extramarks_show_mark:n { g__extramarks_firstmark_##1_tl }
          \__extramarks_show_mark:n { g__extramarks_botmark_##1_tl }
        }
    }
}
\cs_new_protected:Npn \extramarks@restoremarks #1
{
  \seq_map_inline:Nn \g__extramarks_marks_seq
    {
      \tl_gset_eq:cc {g__extramarks_topmark_##1_tl} {l__extramarks_save_topmark_##1_tl}
      \tl_gset_eq:cc {g__extramarks_firstmark_##1_tl} {l__extramarks_save_firstmark_##1_tl}
      \tl_gset_eq:cc {g__extramarks_botmark_##1_tl} {l__extramarks_save_botmark_##1_tl}
      \extramarks@info
        {
          \string \extramarks@restoremarks \space in~\string #1\MessageBreak
          \__extramarks_show_mark:n { g__extramarks_topmark_##1_tl }
          \__extramarks_show_mark:n { g__extramarks_firstmark_##1_tl }
          \__extramarks_show_mark:n { g__extramarks_botmark_##1_tl }
        }
    }
}
\ExplSyntaxOff
\patchcmd{\@topnewpage}{\global \setbox\@currbox
    \color@vbox
      \normalcolor
      \vbox {%
        \hsize\textwidth
        \@parboxrestore
        \col@number \@ne
        #1%
        \vskip -\dbltextfloatsep
             }%
    \color@endbox}
  {\extramarks@set@marks@topnewpage{#1}}
  {\extramarks@info{Patched \string \@topnewpage}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\@topnewpage}}
\patchcmd{\@outputdblcol}{\ifx\@firstcolfirstmark\@empty}
  {\extramarks@get@splitmarks{\outputdblcol \space 1} \ifx\@firstcolfirstmark\@empty}
  {\extramarks@info{Patched \string \@outputdblcol \space 1}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\@outputdblcol \space patch 1}}
\patchcmd{\@outputdblcol}{\global\@firstcolumntrue}
  {\global\@firstcolumntrue\extramarks@getmarks\@outputbox{\@outputdblcol \space 2}}
  {\extramarks@info{Patched \string \@outputdblcol \space 2}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\@outputdblcol \space patch 2}}
\patchcmd {\@opcol} {\@outputpage}
  {\extramarks@getmarks\@outputbox{\@opcol} \@outputpage}
  {\extramarks@info{Patched \string \@opcol}}
  {\msg@error@nnn {extramarks} {cannot-patch} {in \@opcol: \@outputpage} {}}
\apptocmd {\@outputpage}
  {\extramarks@initmarks}
  {\extramarks@info{Patched end of \string \@outputpage}}
  {\msg@error@nnn {extramarks} {cannot-patch} {end of \@outputpage} {}}
\extramarksnewmark{left}
\extramarksnewmark{right}
\ExplSyntaxOn
\NewDocumentCommand \extramarksput { m m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
  {
    \group_begin:
      \cs_set_eq:NN \label    \scan_stop:
      \cs_set_eq:NN \index    \scan_stop:
      \cs_set_eq:NN \glossary \scan_stop:
      \unrestored@protected@xdef \l__extramarks_temp_tl { #2 }
      \tex_marks:D \use:c { c__extramarks_#1_int } {{ \l__extramarks_temp_tl }}
    \group_end:
  }
  { \msg_error:nnnn {extramarks} {not-defined} {\extramarksput} {#1} }
}
\NewExpandableDocumentCommand \extramarkstop { m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
  {
     \exp_last_unbraced:Nv \use:n { g__extramarks_topmark_#1_tl }
  }
  { \msg_error:nnnn {extramarks} {not-defined} {\extramarkstop} {#1} }
}
\NewExpandableDocumentCommand \extramarksfirst { m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
    {
      \tl_if_empty:cTF { g__extramarks_firstmark_#1_tl }
        {
          \exp_last_unbraced:Nv \use:n { g__extramarks_topmark_#1_tl }
        }
        {
          \exp_last_unbraced:Nv \use:n { g__extramarks_firstmark_#1_tl }
        }
    }
    { \msg_error:nnnn {extramarks} {not-defined} {\extramarksfirst} {#1} }
}
\NewExpandableDocumentCommand \extramarkslast { m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
    {
      \tl_if_empty:cTF { g__extramarks_botmark_#1_tl }
        {
          \exp_last_unbraced:Nv \use:n { g__extramarks_topmark_#1_tl }
        }
        {
          \exp_last_unbraced:Nv \use:n { g__extramarks_botmark_#1_tl }
        }
    }
    { \msg_error:nnnn {extramarks} {not-defined} {\extramarkslast} {#1} }
}
\NewExpandableDocumentCommand \ifextramarksmissing { m m m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
    {
      \tl_if_empty:cTF { g__extramarks_firstmark_#1_tl }
        { #2 }
        { #3 }
    }
    { \msg_error:nnnn {extramarks} {not-defined} {\ifextramarksmissing} {#1} }
}
\NewDocumentCommand \extramarksreset { m }
{
  \cs_if_exist:cTF {c__extramarks_#1_int}
    {
      \tl_gset:cn { g__extramarks_topmark_#1_tl } { { } }
      \tl_gset_eq:cN { g__extramarks_firstmark_#1_tl } \c_empty_tl
      \tl_gset_eq:cN { g__extramarks_botmark_#1_tl } \c_empty_tl
    }
    { \msg_error:nnnn {extramarks} {not-defined} {\extramarksreset} {#1} }
}
\NewDocumentCommand \extramarksleft { m }
{
  \extramarksput{left}{#1}
}
\NewDocumentCommand \extramarksright { m }
{
  \extramarksput{right}{#1}
}
\NewDocumentCommand \extramarks { m m }
{
  \extramarksput{left}{#1}
  \extramarksput{right}{#2}
}
\NewExpandableDocumentCommand\firstleftxmark  { } {\extramarksfirst {left}  }
\NewExpandableDocumentCommand\firstrightxmark { } {\extramarksfirst {right} }
\NewExpandableDocumentCommand\topleftxmark    { } {\extramarkstop   {left}  }
\NewExpandableDocumentCommand\toprightxmark   { } {\extramarkstop   {right} }
\NewExpandableDocumentCommand\lastleftxmark   { } {\extramarkslast  {left}  }
\NewExpandableDocumentCommand\lastrightxmark  { } {\extramarkslast  {right} }

\cs_new_eq:NN \firstxmark \firstleftxmark
\cs_new_eq:NN \lastxmark \lastrightxmark
\cs_new_eq:NN \topxmark \topleftxmark
\cs_new_eq:NN \firstrightmark \rightmark
\cs_new_eq:NN \lastleftmark \leftmark

\NewExpandableDocumentCommand\firstleftmark { }
  {\expandafter\@leftmark\firstmark\@empty\@empty}
\NewExpandableDocumentCommand\lastrightmark { }
  {\expandafter\@rightmark\botmark\@empty\@empty}
\cs_new_protected:Npn \extramarks@patch #1
{
  \catcode`\#=12\relax
  \ExplSyntaxOff
  \extramarks@patch@start{#1}
}
\cs_new_protected:Npn \extramarks@patch@start #1 #2 \extramarks@patch@end
{
  \catcode`\#=6\relax
  \AtBeginDocument{
    \@ifpackageloaded{#1}
    {#2}
    { }
  }
  \ExplSyntaxOn
}
\extramarks@patch{multicol}
\pretocmd{\return@nonemptymark}
  {
    \if@boxedmulticols\else
      \extramarks@insert@nonemptymarks {#1} {\return@nonemptymark}\fi
  }
  {\extramarks@info{Patched \string \return@nonemptymark}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\return@nonemptymark}}
\pretocmd{\set@keptmarks}
  {
    \if@boxedmulticols\else\extramarks@get@splitmarks{\set@keptmarks}\fi
  }
  {\extramarks@info{Patched \string \set@keptmarks}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\set@keptmarks}}
\extramarks@patch@end
\@ifpackageloaded{paracol}
  {
    \cs_gset_eq:NN \@outputpage \extramarks@saved@outputpage
    \apptocmd {\pcol@@outputpage}
      {\extramarks@initmarks}
      {\extramarks@info{Patched end of \string \pcol@@outputpage}}
      {\msg@error@nnn {extramarks} {cannot-patch} {end of \pcol@@outputpage}}
  }
  { }
\extramarks@patch{paracol}
\patchcmd{\pcol@ioutputelt}
  {\unvbox\pcol@spanning}
  {\extramarks@getmarks\pcol@spanning{\pcol@ioutputelt}\unvbox\pcol@spanning}
  {\extramarks@info{Patched \string \pcol@ioutputelt \space (\string\pcol@spanning)}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@ioutputelt \space
      (\pcol@spanning)}%
  }
\patchcmd{\pcol@ioutputelt}
  {\ifvoid\@currbox\else}
  {\ifvoid\@currbox\else\extramarks@getmarks\@currbox{\pcol@ioutputelt}}
  {\extramarks@info{Patched \string \pcol@ioutputelt \space
      (\string\@currbox)}%
  }
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@ioutputelt \space
      (\string\@currbox)}%
  }
\patchcmd{\pcol@makeflushedpage}
  {\advance\@tempdima\dp\pcol@spanning}
  {\advance\@tempdima\dp\pcol@spanning
    \extramarks@getmarks\pcol@spanning{\pcol@makeflushedpage
      (\string\pcol@spanning)}%
  }
  {\extramarks@info{Patched \string \pcol@makeflushedpage \space
      (\string\pcol@spanning)}%
  }
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@makeflushedpage
      \space (\pcol@spanning)}%
  }
\patchcmd{\pcol@imakeflushedpage}
  {\pcol@getcurrcol}
  {\pcol@getcurrcol\extramarks@getmarks\@currbox{\pcol@imakeflushedpage}}
  {\extramarks@info{Patched \string \pcol@imakeflushedpage \space
      (\string\@currbox)}%
  }
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@imakeflushedpage \space
      (\string\@currbox)}%
  }
\patchcmd{\pcol@outputpage@l}
  {\global\c@page#1\relax}
  {\global\c@page#1\relax\extramarks@getmarks\@outputbox{\pcol@outputpage@l}}
  {\extramarks@info{Patched \string \pcol@outputpage@l}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@outputpage@l}}
\patchcmd{\pcol@outputpage@r}
  {\global\c@page#1\relax}
  {\global\c@page#1\relax\extramarks@getmarks\pcol@rightpage{\pcol@outputpage@r}}
  {\extramarks@info{Patched \string \pcol@outputpage@r}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@outputpage@r}}
\patchcmd{\pcol@makecol}
  {\@minus.0001fil}
  {\@minus\maxdimen}
  {\extramarks@info{Patched \string \pcol@makecol}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@makecol}}
\patchcmd{\pcol@combinefloats}
  {\@minus.0001fil}
  {\@minus\maxdimen}
  {\extramarks@info{Patched \string \pcol@combinefloats \space 1}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@combinefloats \space 1}}
\patchcmd{\pcol@combinefloats}
  {\@minus-.0001fil}
  {\@minus-\maxdimen}
  {\extramarks@info{Patched \string \pcol@combinefloats \space 1}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@combinefloats \space 2}}
\patchcmd{\pcol@synccolumn}
  {\@minus.0001fil}
  {\@minus\maxdimen}
  {\extramarks@info{Patched \string \pcol@synccolumn \space 1}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@synccolumn \space 1}}
\patchcmd{\pcol@synccolumn}
  {\global\pcol@prevdepth\@tempdimc}
  {\global\pcol@prevdepth\@tempdimc
    \extramarks@savemarks {\pcol@synccolumn}%
    \extramarks@getlocalmarks \@currbox {\pcol@synccolumn}%
  }
  {\extramarks@info{Patched \string \pcol@synccolumn \space 2}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@synccolumn \space 2}}
\patchcmd{\pcol@synccolumn}
  {\vbox to\@tempdimb{\unvbox\@currbox \vskip\z@\@plus.0001fil}\fi}
  {\vbox to\@tempdimb{\unvbox\@currbox \vskip\z@\@plus.0001fil}\fi
    \extramarks@insert@nonemptymarks{first}{\pcol@synccolumn}%
    \extramarks@insert@nonemptymarks{bot}{\pcol@synccolumn}%
    \extramarks@restoremarks{\pcol@synccolumn}%
  }
  {\extramarks@info{Patched \string \pcol@synccolumn \space 3}}
  {\msg@error@nnn {extramarks} {cannot-patch} {\pcol@synccolumn \space 3}}
\extramarks@patch@end
\ExplSyntaxOff
\endinput
%%
%% End of file `extramarks.sty'.
