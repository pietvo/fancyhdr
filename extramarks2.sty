%%
%% This is file `extramarks2.sty',
%%
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks2}
           [2021/03/04 v0.1
                  Extra marks for LaTeX]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{expl3,xparse}
\RequirePackage{etoolbox}

\ExplSyntaxOn

% Pick up traditional macros
%
\cs_new_eq:NN \newmarks:N \newmarks
\cs_generate_variant:Nn \newmarks:N { c }

\seq_new:N \l__extramarks_xmarks_seq

% Create a new mark

\NewDocumentCommand \extramarksnewmark { m } {
  \newmarks:c {extramarks@#1}
  \seq_put_right:Nn \l__extramarks_xmarks_seq { #1 }
}

\ExplSyntaxOff

% For internal use in \@outputdblcol

\newcommand\extramarks@savemarks{%
  \extramarks@savefirstxmark{left}%
  \extramarks@savefirstxmark{right}%
}

\newcommand\extramarks@setmarks{%
  \extramarks@setxmarkleft
  \extramarks@setxmarkright
}

\newcommand\extramarks@@setxmarks[1]{% %1 = left/right
  \csletcs{extramarks@firstmark@#1}{@firstcolfirstxmark@#1}%
  \csletcs{extramarks@topmark@#1}{@firstcoltopxmark@#1}%
 }

\newcommand\extramarks@savefirstxmark[1]{% 1 = left/right
    \toks@\expandafter{\topmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcoltopxmark@#1}{\the\toks@}%
    \toks@\expandafter{\splitfirstmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcolfirstxmark@#1}{\the\toks@}%
    \ifcsempty{@firstcolfirstxmark@#1}
      {\global\cslet{extramarks@setxmark#1}\relax}
      {\csgdef{extramarks@setxmark#1}{\extramarks@@setxmarks{#1}}}%
}

\patchcmd{\@outputdblcol}{\ifx\@firstcolfirstmark\@empty}
  {\extramarks@savemarks\ifx\@firstcolfirstmark\@empty}
  {}{\ERROR patch 1 \string\ifx\string\@firstcolfirstmark}

\patchcmd{\@outputdblcol}{\@combinedblfloats}
  {\@combinedblfloats\extramarks@setmarks}
  {}{\ERROR patch 2 \string\@combinedblfloats}

% End of \@outputdblcol patching code

\let\firstrightmark \rightmark
\let\lastleftmark \leftmark

% Variables and commands for a new mark ⟨xxxx⟩ :
% \extramarks@⟨xxxx⟩ : the mark
% \extramarks⟨xxxx⟩ : command to set the mark
% \extramarks@firstmark@⟨xxxx⟩ : firstmark (braced)
% \extramarks@topmark@⟨xxxx⟩ : topmark (braced)
% \extramarks@botmark@⟨xxxx⟩ : botmark (braced)
% \first⟨xxxx⟩xmark : firstmark (user level)
% \top⟨xxxx⟩xmark : topmark (user level)
% \last⟨xxxx⟩xmark : lastmark (user level)
%  In \@outputdblcol:
%  \extramarks@setxmark⟨xxxx⟩
%  \@firstcolfirstxmark@⟨xxxx⟩
%  \@firstcoltopxmark@⟨xxxx⟩
 
\extramarksnewmark{left}
\extramarksnewmark{right}

% Put extra pair of braces around the marks, to distinguish
% an empty mark from the absence of a mark

\newcommand\extramarksleft[1]{\marks\extramarks@left{{#1}}}
\newcommand\extramarksright[1]{\marks\extramarks@right{{#1}}}
\newcommand\extramarks[2]{\extramarksleft{#1}\extramarksright{#2}}

% These are variables for the marks with braces.
% The \extramarks@firstmark@... and \extramarks@topmark@...
% can be temporarily changed inside the output routine

\def\extramarks@firstmark@left{\firstmarks\extramarks@left}
\def\extramarks@topmark@left{\topmarks\extramarks@left}
\def\extramarks@botmark@left{\botmarks\extramarks@left}
\def\extramarks@firstmark@right{\firstmarks\extramarks@right}
\def\extramarks@topmark@right{\topmarks\extramarks@right}
\def\extramarks@botmark@right{\botmarks\extramarks@right}

% Remove outer braces from the marks

\def\firstleftxmark{\expandafter\@firstofone{\extramarks@firstmark@left}}
\def\firstrightxmark{\expandafter\@firstofone{\extramarks@firstmark@right}}
\def\topleftxmark{\expandafter\@firstofone{\extramarks@topmark@left}}
\def\toprightxmark{\expandafter\@firstofone{\extramarks@topmark@right}}
\def\lastleftxmark{\expandafter\@firstofone{\extramarks@botmark@left}}
\def\lastrightxmark{\expandafter\@firstofone{\extramarks@botmark@right}}

\let\firstxmark\firstleftxmark
\let\lastxmark\lastrightxmark
\let\topxmark\topleftxmark

% \endinput
%%
%% End of file `extramarks2.sty'.
