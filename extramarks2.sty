%%
%% This is file `extramarks2.sty',
%%
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks2}
           [2021/03/05 v0.1
                  Extra marks for LaTeX]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{expl3,xparse}
\RequirePackage{etoolbox}

\ExplSyntaxOn

% Pick up traditional macros
%
\cs_new_eq:NN \newmarks:N \newmarks
\cs_generate_variant:Nn \newmarks:N { c }

\seq_new:N \l__extramarks_xmarks_seq
\tl_new:N \l__temp_tl

% Create a new mark

\NewDocumentCommand \extramarksnewmark { m } {
  % Create the mark
  \newmarks:c {g__extramarks_#1}
  % Put it in the list of marks
  \seq_put_right:Nn \l__extramarks_xmarks_seq { #1 }
}

% For internal use in \@outputdblcol

\cs_new_protected:Nn \__extramarks_savemarks:{%
  \seq_map_tokens:Nn \l__extramarks_xmarks_seq {\__extramarks_savefirstxmark:n}
}

\cs_new_protected:Nn \__extramarks_setmarks:{%
  \seq_map_inline:Nn \l__extramarks_xmarks_seq { 
    \cs:w __extramarks_setxmark ##1: \cs_end:
  }
}

\cs_new_protected:Npn \__extramarks__setxmarks:n #1 { % #1 = left/right
  \cs_set_eq:cc {extramarks_firstmark_#1} {g__extramarks_save_firstxmark_#1}
  \cs_set_eq:cc {extramarks_topmark_#1} {g__extramarks_save_topxmark_#1}
 }

\cs_new_protected:Npn \__extramarks_savefirstxmark:n #1 { % #1 = left/right
    \toks@ \exp_after:wN {\topmarks\csname g__extramarks_#1\endcsname}
    \tl_gset:cx {g__extramarks_save_topxmark_#1} {\the\toks@}
    \toks@ \exp_after:wN{\splitfirstmarks\csname g__extramarks_#1\endcsname}
    \tl_gset:cx {g__extramarks_save_firstxmark_#1} {\the\toks@}
    \tl_if_empty:cTF {g__extramarks_save_firstxmark_#1}
      {\cs_gset_eq:cN {__extramarks_setxmark#1:} \relax}
      {\cs_gset:cn {__extramarks_setxmark#1:} {\__extramarks__setxmarks:n{#1}}}
}

\patchcmd{\@outputdblcol}{\ifx\@firstcolfirstmark\@empty}
  {\__extramarks_savemarks:\ifx\@firstcolfirstmark\@empty}
  {}{\ERROR patch 1 \string\ifx\string\g__extramarks_save_firstmark}

\patchcmd{\@outputdblcol}{\@combinedblfloats}
  {\@combinedblfloats\__extramarks_setmarks:}
  {}{\ERROR patch 2 \string\@combinedblfloats}

% End of \@outputdblcol patching code

% Variables and commands for a new mark ⟨xxxx⟩ :
% \g__extramarks_⟨xxxx⟩ : the mark (number as a char)
% \extramarks⟨xxxx⟩ : command to set the mark
% \extramarks_firstmark_⟨xxxx⟩ : firstmark (braced)
% \extramarks_topmark_⟨xxxx⟩ : topmark (braced)
% \extramarks_botmark_⟨xxxx⟩ : botmark (braced)
% \first⟨xxxx⟩xmark : firstmark (user level)
% \top⟨xxxx⟩xmark : topmark (user level)
% \last⟨xxxx⟩xmark : lastmark (user level)
%  In \@outputdblcol:
%  \__extramarks_setxmark⟨xxxx⟩:
%  \g__extramarks_save_firstxmark_⟨xxxx⟩
%  \g__extramarks_save_topxmark_⟨xxxx⟩

% Put extra pair of braces around the marks, to distinguish
% an empty mark from the absence of a mark

\newcommand\extramarksleft[1]{\marks\g__extramarks_left{{#1}}}
\newcommand\extramarksright[1]{\marks\g__extramarks_right{{#1}}}
\newcommand\extramarks[2]{\extramarksleft{#1}\extramarksright{#2}}

% These are variables for the marks with braces.
% The \extramarks_firstmark_... and \extramarks_topmark_...
% can be temporarily changed inside the output routine

\def\extramarks_firstmark_left{\firstmarks\g__extramarks_left}
\def\extramarks_topmark_left{\topmarks\g__extramarks_left}
\def\extramarks_botmark_left{\botmarks\g__extramarks_left}
\def\extramarks_firstmark_right{\firstmarks\g__extramarks_right}
\def\extramarks_topmark_right{\topmarks\g__extramarks_right}
\def\extramarks_botmark_right{\botmarks\g__extramarks_right}

% Remove outer braces from the marks

\def\firstleftxmark{\exp_after:wN\use:n{\extramarks_firstmark_left}}
\def\firstrightxmark{\exp_after:wN\use:n{\extramarks_firstmark_right}}
\def\topleftxmark{\exp_after:wN\use:n{\extramarks_topmark_left}}
\def\toprightxmark{\exp_after:wN\use:n{\extramarks_topmark_right}}
\def\lastleftxmark{\exp_after:wN\use:n{\extramarks_botmark_left}}
\def\lastrightxmark{\exp_after:wN\use:n{\extramarks_botmark_right}}

\ExplSyntaxOff
 
\extramarksnewmark{left}
\extramarksnewmark{right}

\let\firstxmark\firstleftxmark
\let\lastxmark\lastrightxmark
\let\topxmark\topleftxmark

\let\firstrightmark \rightmark
\let\lastleftmark \leftmark

% \endinput
%%
%% End of file `extramarks2.sty'.
