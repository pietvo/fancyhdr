%%
%% This is file `extramarks2.sty',
%% 
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%% 
%%    http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks2}
           [2021/03/02 v4.1
                  Extra marks for LaTeX]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{etoolbox}
\newcommand\@@setxmarks[1]{% %1 = left/right
   \csletcs{first#1xmark}{@firstcolfirstxmark@#1}%
   \csletcs{top#1xmark}{@firstcoltopxmark@#1}%
 }

\newcommand\@savefirstxmark[1]{% 1 = left/right
    \toks@\expandafter{\topmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcoltopxmark@#1}{\the\toks@}%
    \toks@\expandafter{\splitfirstmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcolfirstxmark@#1}{\the\toks@}%
    \ifcsempty{@firstcolfirstxmark@#1}
        {\global\cslet{@setxmark#1}\relax}
       {\csgdef{@setxmark#1}{\@@setxmarks{#1}}}%
%    \expandafter\show\csname @setxmark#1\endcsname
}

\patchcmd{\@outputdblcol}{\ifx\@firstcolfirstmark\@empty\global\let\@setmarks\relax}
   {\@savefirstxmark{left}%
    \@savefirstxmark{right}%
    \ifx\@firstcolfirstmark\@empty
    \gdef\@setmarks{%
        \@setxmarkleft
        \@setxmarkright
        }
      }
     {}{\ERROR patch 1 \string\ifx\string\@firstcolfirstmark}

\patchcmd{\@outputdblcol}{\gdef\@setmarks}
   {\@savefirstxmark{left}\@savefirstxmark{right}\gdef\@setmarks}
   {}{\ERROR patch 2 \string\gdef\string\@setmarks}

\patchcmd{\@outputdblcol}{\let\topmark\@firstcoltopmark}
   {\message{patch}\let\topmark\@firstcoltopmark
        \@setmarkleft
        \@setmarkright
   }
   {}{\ERROR patch 3 \string\gdef\string\@setmarks}

\let\firstrightmark \rightmark
\let\lastleftmark \leftmark

\newmarks\extramarks@left
\newmarks\extramarks@right

\newcommand{\extraleftmark}[1]{\marks\extramarks@left{#1}}
\newcommand{\extrarightmark}[1]{\marks\extramarks@right{#1}}
\newcommand\extramarks[2]{\extraleftmark{#1}\extrarightmark{#2}}

\def\firstleftxmark{\firstmarks\extramarks@left}
\def\firstrightxmark{\firstmarks\extramarks@right}
\def\topleftxmark{\topmarks\extramarks@left}
\def\toprightxmark{\topmarks\extramarks@right}
\def\lastleftxmark{\botmarks\extramarks@left}
\def\lastrightxmark{\botmarks\extramarks@right}

\def\firstxmark{\firstleftxmark}
\def\lastxmark{\lastrightxmark}
\def\topxmark{\topleftxmark}

% \endinput
%%
%% End of file `extramarks2.sty'.
