%%
%% This is file `extramarks2.sty',
%% 
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.3 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%% 
%%    http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3 or later is part of all distributions of LaTeX version
%% 2005/12/01 or later.
%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{extramarks2}
           [2021/03/02 v4.1
                  Extra marks for LaTeX]
% Copyright (C) 2021 by Pieter van Oostrum <pieter@vanoostrum.org>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{expl3,xparse}
\RequirePackage{etoolbox}

\newcommand\extramarks@savemarks{%
  \extramarks@savefirstxmark{left}%
  \extramarks@savefirstxmark{right}%
}

\newcommand\extramarks@setmarks{%
  \extramarks@setxmarkleft
  \extramarks@setxmarkright
}

\newcommand\extramarks@@setxmarks[1]{% %1 = left/right
  \csletcs{first#1xmark}{@firstcolfirstxmark@#1}%
  \csletcs{top#1xmark}{@firstcoltopxmark@#1}%
 }

\newcommand\extramarks@savefirstxmark[1]{% 1 = left/right
    \toks@\expandafter{\topmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcoltopxmark@#1}{\the\toks@}%
    \toks@\expandafter{\splitfirstmarks\csname extramarks@#1\endcsname}%
    \csxdef{@firstcolfirstxmark@#1}{\the\toks@}%
    \ifcsempty{@firstcolfirstxmark@#1}
      {\global\cslet{extramarks@setxmark#1}\relax}
      {\csgdef{extramarks@setxmark#1}{\extramarks@@setxmarks{#1}}}%
}

\patchcmd{\@outputdblcol}{\ifx\@firstcolfirstmark\@empty}
  {\extramarks@savemarks\ifx\@firstcolfirstmark\@empty}
  {}{\ERROR patch 1 \string\ifx\string\@firstcolfirstmark}

\patchcmd{\@outputdblcol}{\@combinedblfloats}
  {\@combinedblfloats\extramarks@setmarks}
  {}{\ERROR patch 2 \string\gdef\string\@setmarks}

\let\firstrightmark \rightmark
\let\lastleftmark \leftmark

\newmarks\extramarks@left
\newmarks\extramarks@right

% Put extra pair of braces around the marks, to distinguish
% an empty mark from the absence of a mark
%
\newcommand\extramarksleft[1]{\marks\extramarks@left{{#1}}}
\newcommand\extramarksright[1]{\marks\extramarks@right{{#1}}}
\newcommand\extramarks[2]{\extramarksleft{#1}\extramarksright{#2}}

% Remove outer braces from the marks
%
\def\firstleftxmark{\expandafter\@firstofone{\firstmarks\extramarks@left}}
\def\firstrightxmark{\expandafter\@firstofone{\firstmarks\extramarks@right}}
\def\topleftxmark{\expandafter\@firstofone{\topmarks\extramarks@left}}
\def\toprightxmark{\expandafter\@firstofone{\topmarks\extramarks@right}}
\def\lastleftxmark{\expandafter\@firstofone{\botmarks\extramarks@left}}
\def\lastrightxmark{\expandafter\@firstofone{\botmarks\extramarks@right}}

% Use \def here instead of \et, because \firstleftxmark
% and \topleftxmark can be temporarily changed in the output routine
%
\def\firstxmark{\firstleftxmark}
\def\lastxmark{\lastrightxmark}
\def\topxmark{\topleftxmark}

% \endinput
%%
%% End of file `extramarks2.sty'.
